properties:
  displayName: CyngularAuditEventPolicy
  description: >-
    This policy ensures that diagnostics settings are configured to write logs
    to a storage account in the same region as the monitored Azure resource.
  policyType: Custom
  mode: All
  metadata:
    category: Monitoring
  parameters:
    resourceTypes:
      type: Array
      metadata:
        displayName: Resource Types
        description: List of Azure resource types to apply the policy.
      defaultValue:
        - Microsoft.Storage/storageAccounts
        - Microsoft.Network/virtualNetworks
        - Microsoft.Network/networkWatchers
        - Microsoft.Network/networkInterfaces
        - microsoft.network/routetables
        - microsoft.network/privateendpoints
        - Microsoft.Network/loadBalancers
        - Microsoft.Network/networkManagers
        - Microsoft.Network/networkSecurityGroups
        - Microsoft.Web/serverFarms
        - Microsoft.Web/sites
        - Microsoft.Compute/disks
        - Microsoft.Compute/snapshots
        - Microsoft.Compute/sshPublicKeys
        - Microsoft.Compute/virtualMachines
        - microsoft.compute/availabilitysets
        - microsoft.compute/virtualmachines/extensions
        - Microsoft.Compute/virtualMachineScaleSets
        - microsoft.operationsmanagement/solutions
        - microsoft.managedidentity/userassignedidentities
        - microsoft.devtestlab/labs
        - microsoft.databricks/accessconnectors
        - Microsoft.Databricks/workspaces
        - microsoft.operationalinsights/querypacks
        - Microsoft.EventGrid/systemTopics
        - microsoft.insights/components
        - Microsoft.ContainerService/managedClusters
        - Microsoft.RecoveryServices/vaults
        - Microsoft.KeyVault/vaults
        - Microsoft.Sql/servers
        - Microsoft.ClassicNetwork/networkSecurityGroups
        - Microsoft.ServiceBus/namespaces
        - Microsoft.DBforPostgreSQL/flexibleServers
        - microsoft.compute/images
        - microsoft.devtestlab/schedules
    storageAccountRegionMap:
      type: Object
      metadata:
        displayName: Storage Accounts Region Map
        description: Mapping of regions to storage account IDs
      defaultValue:
        westeurope: "/subscriptions/b6c14413-fb13-4063-acd5-d47e2537a7ba/resourceGroups/cyngular-asos-rg/providers/Microsoft.Storage/storageAccounts/cyngularasoswesteurope"
        eastus: "/subscriptions/b6c14413-fb13-4063-acd5-d47e2537a7ba/resourceGroups/cyngular-asos-rg/providers/Microsoft.Storage/storageAccounts/cyngularasoseastus"
        westus: "/subscriptions/b6c14413-fb13-4063-acd5-d47e2537a7ba/resourceGroups/cyngular-asos-rg/providers/Microsoft.Storage/storageAccounts/cyngularasoswestus"
  policyRule:
    if:
      allOf:
        - field: type
          notIn: '[parameters(''resourceTypes'')]'
    then:
      effect: deployIfNotExists
      details:
        type: Microsoft.Insights/diagnosticSettings
        roleDefinitionIds:
          - "/providers/Microsoft.Authorization/roleDefinitions/StorageAccountContributor"
        deployment:
          properties:
            mode: incremental
            parameters:
              resourceName:
                value: '[field(''name'')]'
              location:
                value: '[field(''location'')]'
              storageAccountId:
                value: '[parameters(''storageAccountRegionMap'')[field(''location'')]]'
            template:
              $schema: "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
              contentVersion: "1.0.0.0"
              parameters:
                resourceName:
                  type: string
                location:
                  type: string
                storageAccountId:
                  type: string
              resources:
                - type: Microsoft.Insights/diagnosticSettings
                  apiVersion: 2017-05-01-preview
                  name: '[concat(parameters(''resourceName''), ''-diagnostics'')]'
                  location: '[parameters(''location'')]'
                  properties:
                    storageAccountId: '[parameters(''storageAccountId'')]'
                    logs:
                      - category: AuditEvent
                        enabled: true
